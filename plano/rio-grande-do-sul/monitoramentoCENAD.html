<section>
  <div id="blogContainer"></div>
</section>

<script>
  function fetchAllPages(url) {
    return fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error(`Error fetching the page. Response status: ${response.status}`);
        }
        return response.text();
      })
      .then(html => {
        let resultHTML = html;

        const tempElement = document.createElement("div");
        tempElement.innerHTML = resultHTML;

        const pagination = tempElement.querySelector('.pagination-container');
        if (!pagination) return html;

        const lastPageLink = pagination.querySelector('.pagination-last a').getAttribute('href');

        const regex = /page=(\d+)/;
        const match = lastPageLink.match(regex);

        // Assuming the base URL is known and provided here
        const baseURL = 'https://brasilparticipativo.presidencia.gov.br';

        if (match) {
          const totalPageNumber = parseInt(match[1], 10);
          const fetchPromises = [];

          for (let i = 2; i <= totalPageNumber; i++) {
            // Create the new URL by combining the base URL with the replaced page number in the href
            const newURL = `${baseURL}${lastPageLink.replace(regex, `page=${i}`)}`;

            fetchPromises.push(
              fetchHTML(newURL)
                .then(pageHtml => {
                  // Append each fetched news-item to resultHTML
                  resultHTML += pageHtml;
                })
                .catch(error => {
                  console.error('Error fetching page:', error);
                })
            );
          }

          // Wait for all fetches to complete before returning resultHTML
          return Promise.all(fetchPromises).then(() => resultHTML);
        } else {
          console.log('Page number not found');
          return resultHTML;
        }
      })
      .catch(error => {
        throw new Error(`Error fetching the page: ${error.message}`);
      });
  }

  function fetchHTML(url) {
    return fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error(`Error fetching the page. Response status: ${response.status}`);
        }
        return response.text();
      })
      .then(html => {
        return html;
      })
      .catch(error => {
        throw new Error(`Error fetching the page: ${error.message}`);
      });
  }

  // Helper function to parse date from text and return as Date object
  function parseDateFromText(dateString) {
    const [day, month, year] = dateString.split('/').map(Number); // Split and convert to numbers
    // Adjust year to handle YY format, assuming 20XX for simplicity
    const fullYear = year < 100 ? 2000 + year : year;
    return new Date(fullYear, month - 1, day); // Convert to Date object
  }

  // Function to format a Date object into DD/MM/YY string
  function formatDateToDDMMYY(date) {
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0'); // January is 0!
    const year = date.getFullYear().toString().substring(2); // Get last two digits
    return `${day}/${month}/${year}`;
  }

  // Generates blog components and returns the complete HTML
  function generateBlogHTML(url, originalHTML) {
    const tempElement = document.createElement('div');
    tempElement.innerHTML = originalHTML;

    const originalNewsElements = tempElement.querySelectorAll('.news-item');
    const resultHTMLArray = [];
    let latestDate = new Date(0); // Initialize with an old date

    originalNewsElements.forEach(originalNewsElement => {
      let titleElement = originalNewsElement.querySelector('.news-title');
      let titleContent = titleElement.textContent.trim();
      let hrefPost = titleElement.getAttribute('href');
      if (!titleElement) {
        console.log('No title element');
        titleElement = '';
        titleContent = '';
        hrefPost = '#';
      }
      else{
        titleContent = titleElement.textContent.trim();
        hrefPost = titleElement.getAttribute('href');
      }

      const descriptionElement = originalNewsElement.querySelector('.news-description');
      let fullDescription;
      let subtitleContent = ''; // Extract subtitle after hyphen

      if (!descriptionElement) {
        console.log('No description element');
        descriptionElement = '';
      }
      else {
        fullDescription = descriptionElement.textContent.trim();
        subtitleContent = fullDescription.split('-')[1].trim(); // Extract subtitle after hyphen
        const dateExtracted = parseDateFromText(fullDescription.split('-')[0].trim()); // Extract and parse date
        if (dateExtracted > latestDate) {
          latestDate = dateExtracted; // Save the bigger (more recent) date
        }
      }

      const htmlTemplate = `
        <div class="news-container">
          <a href="${hrefPost}" class="news-title-link">
            <h3 class="news-title">${subtitleContent}</h3>
            <p class="news-subtitle">${titleContent}</p>
          </a>
        </div>
      `;

      resultHTMLArray.push(htmlTemplate);
    });

    let resultHTML = `
        <div>
          ${formatDateToDDMMYY(latestDate)}
        </div>
    `;
    resultHTML += resultHTMLArray.join('\n');
    resultHTML += "</div></section>";

    return resultHTML;
  }


  // Calls the fetchHTML and generateBlogHTML functions asynchronously
  function generateBlog(url, title) {
    fetchAllPages(url)
      .then(html => {
        return generateBlogHTML(url, html);
      })
      .then(newsContent => {
        if (newsContent !== "error") {
          let blogContent = `<section class="">
                                  <span class="">${title}</span>
                                  <div class="">`;
          blogContent += newsContent;

          const blogContainer = document.querySelector('#blogContainer');

          if (blogContainer) {
            blogContainer.innerHTML = blogContent;
          } else {
            console.error('Element with id "blogContainer" not found.');
          }
        } else {
          console.error('Error fetching news.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  // !!!!ONLY NEED TO CALL THIS FUNCTION TO GENERATE THE NEWS!!!!
  // Information about the variables in readme.md
  const url = 'https://brasilparticipativo.presidencia.gov.br/processes/unidospelors/f/114/';
  const title = 'Monitoramento CENAD';

  generateBlog(url, title);
</script>